<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Results</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Code Review Results</h1>

<div class="container">
    <h2>Detected Issues</h2>

    <div id="issuesList">
        <!-- Issues will be dynamically inserted here -->
    </div>
</div>

<div class="container">
    <h2>Final Review Report</h2>
    <p><button onclick="generateReport()">Generate Report</button>
</button>

<div id="finalReport" class="container" style="display:none;">
    <h2>Final Review Report</h2>
    <div id="reportContent"></div>
</div>

</p>
</div>


<div class="brand">verreaux-ai</div>

<div class="back-btn-container">
    <a href="index.html" class="back-btn">← Back to Code Review</a>
</div>

<script src="web.js"></script>
<script>
window.onload = function() {
    let code = sessionStorage.getItem("codeToReview");
    if (!code) {
        document.getElementById("issuesList").innerHTML = '<p style="color: #f87171;">No code found. Please submit code first.</p>';
        return;
    }
    
    let textarea = document.createElement("textarea");
    textarea.id = "codeInput";
    textarea.value = code;
    textarea.style.display = "none";
    document.body.appendChild(textarea);
    
    let lines = code.split("\n");
    
    let rule1 = findUnusedVariables(code, lines);
    let rule2 = findExcessiveNesting(code, lines);
    let rule3 = findMagicNumbers(code, lines);
    let rule4 = findLongFunctions(code, lines);
    
    allIssues = rule1.concat(rule2).concat(rule3).concat(rule4);
    allIssues.sort(function(a, b) {
        return a.line - b.line;
    });
    
    let issuesList = document.getElementById("issuesList");
    
    if (allIssues.length === 0) {
        issuesList.innerHTML = '<p style="color: #4ade80; font-size: 18px;">✓ No issues detected! Your code looks good.</p>';
        document.getElementById("reviewStatus").textContent = "Passed";
        return;
    }
    
    allIssues.forEach(function(issue) {
        let issueDiv = document.createElement("div");
        issueDiv.className = "issue";
        
        let severityClass = "";
        if (issue.severity === "error") severityClass = "high";
        else if (issue.severity === "warning") severityClass = "medium";
        else severityClass = "low";
        
        let safeCode = issue.code || "";
        try {
            safeCode = escapeHtml(issue.code);
        } catch(e) {
            safeCode = issue.code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        issueDiv.innerHTML = 
            '<p><strong>Line Number:</strong> ' + issue.line + '</p>' +
            '<p><strong>Issue Type:</strong> ' + issue.type + '</p>' +
            '<p><strong>Severity:</strong> <span class="' + severityClass + '">' + issue.severity.toUpperCase() + '</span></p>' +
            '<p><strong>Explanation:</strong> ' + issue.explanation + '</p>' +
            '<p><strong>Code:</strong></p>' +
            '<div style="background-color: #1e293b; padding: 10px; border-radius: 5px; font-family: Consolas, monospace; margin: 10px 0; color: #a5f3fc; border: 1px solid #334155;">' + 
                safeCode + 
            '</div>' +
            '<p><strong>Suggested Improvement:</strong> ' + issue.suggestion + '</p>' +
            '<label><input type="checkbox"> Accept</label>' +
            '<label><input type="checkbox"> Reject</label>';
        
        issuesList.appendChild(issueDiv);
    });
    
    let hasErrors = allIssues.some(function(issue) {
        return issue.severity === "error";
    });
};

function generateReport() {
    let reportBox = document.getElementById("finalReport");
    let reportContent = document.getElementById("reportContent");

    reportContent.innerHTML = "";

    if (!allIssues || allIssues.length === 0) {
        reportContent.innerHTML = "<p style='color:#4ade80'>✓ No issues found. Code approved.</p>";
    } else {
        allIssues.forEach(function(issue) {
            let div = document.createElement("div");
            div.style.borderBottom = "1px solid #334155";
            div.style.padding = "8px 0";

            div.innerHTML =
                "<strong>Line " + issue.line + "</strong> — " +
                issue.type +
                " <span style='color:#38bdf8'>(" + issue.severity + ")</span>";

            reportContent.appendChild(div);
        });
    }

    reportBox.style.display = "block";
}
</script>

</body>
</html>