<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Review Results</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Code Review Results</h1>

<div class="container">
    <h2>Detected Issues</h2>

    <div id="issuesList">
        <!-- Issues will be dynamically inserted here by web.js -->
    </div>
</div>

<div class="container">
    <h2>Review Actions</h2>
    <p>Review all the issues above and accept or reject them. Once all issues are reviewed, you can generate the final report.</p>
    <button id="btnGenerateReport" onclick="generateReport()" style="margin-top: 15px;">Generate Final Report</button>
</div>

<div class="container" id="reportSection" style="display: none;">
    <h2>Final Review Report</h2>
    <p>Status: <strong id="reviewStatus">Complete</strong></p>
    
    <div id="reportRows">
        <!-- Report rows will be inserted here -->
    </div>
</div>

<div class="brand">verreaux-ai</div>

<div class="back-btn-container">
    <a href="index.html" class="back-btn">← Back to Code Review</a>
</div>

<script src="web.js"></script>
<script>
// Store all issues globally so web.js functions can access them
let allIssues = [];

// Load code from sessionStorage and analyze it
window.onload = function() {
    let code = sessionStorage.getItem("codeToReview");
    if (!code) {
        document.getElementById("issuesList").innerHTML = '<p style="color: #f87171;">No code found. Please submit code first.</p>';
        document.getElementById("btnGenerateReport").style.display = "none";
        return;
    }
    
    // Put the code into a hidden textarea so web.js can read it
    let textarea = document.createElement("textarea");
    textarea.id = "codeInput";
    textarea.value = code;
    textarea.style.display = "none";
    document.body.appendChild(textarea);
    
    // Split code into lines for analysis
    let lines = code.split("\n");
    
    // Run all the rules from web.js
    let rule1 = findUnusedVariables(code, lines);
    let rule2 = findExcessiveNesting(code, lines);
    let rule3 = findMagicNumbers(code, lines);
    let rule4 = findLongFunctions(code, lines);
    
    allIssues = rule1.concat(rule2).concat(rule3).concat(rule4);
    allIssues.sort(function(a, b) {
        return a.line - b.line;
    });
    
    // Give each issue an ID and status
    allIssues.forEach(function(issue, index) {
        issue.id = index + 1;
        issue.status = "pending";
    });
    
    // Display the issues
    let issuesList = document.getElementById("issuesList");
    
    if (allIssues.length === 0) {
        issuesList.innerHTML = '<p style="color: #4ade80; font-size: 18px;">✓ No issues detected! Your code looks good.</p>';
        document.getElementById("btnGenerateReport").style.display = "none";
        return;
    }
    
    // Create issue cards with Accept/Reject buttons
    allIssues.forEach(function(issue) {
        let issueDiv = document.createElement("div");
        issueDiv.className = "issue";
        issueDiv.id = "issue-" + issue.id;
        
        let severityClass = "";
        if (issue.severity === "error") severityClass = "high";
        else if (issue.severity === "warning") severityClass = "medium";
        else severityClass = "low";
        
        issueDiv.innerHTML = 
            '<p><strong>Line Number:</strong> ' + issue.line + '</p>' +
            '<p><strong>Issue Type:</strong> ' + issue.type + '</p>' +
            '<p><strong>Severity:</strong> <span class="' + severityClass + '">' + issue.severity.toUpperCase() + '</span></p>' +
            '<p><strong>Explanation:</strong> ' + issue.explanation + '</p>' +
            '<p><strong>Suggested Improvement:</strong> ' + issue.suggestion + '</p>' +
            '<div id="actions-' + issue.id + '">' +
                '<label><input type="checkbox" onchange="acceptIssue(' + issue.id + ')"> Accept</label>' +
                '<label><input type="checkbox" onchange="rejectIssue(' + issue.id + ')"> Reject</label>' +
            '</div>';
        
        issuesList.appendChild(issueDiv);
    });
};

// Accept an issue
function acceptIssue(issueId) {
    let issue = allIssues.find(function(item) {
        return item.id === issueId;
    });
    if (issue) {
        issue.status = "accepted";
        updateIssueDisplay(issueId, "accepted");
    }
}

// Reject an issue
function rejectIssue(issueId) {
    let issue = allIssues.find(function(item) {
        return item.id === issueId;
    });
    if (issue) {
        issue.status = "rejected";
        updateIssueDisplay(issueId, "rejected");
    }
}

// Update the issue display to show decision
function updateIssueDisplay(issueId, decision) {
    let actionsDiv = document.getElementById("actions-" + issueId);
    let badgeText = (decision === "accepted") ? "✓ Accepted" : "✗ Rejected";
    let badgeColor = (decision === "accepted") ? "#4ade80" : "#f87171";
    
    actionsDiv.innerHTML = '<p style="color: ' + badgeColor + '; font-weight: bold; margin-top: 10px;">' + badgeText + '</p>';
}

// Override generateReport to show the report section
let originalGenerateReport = generateReport;
generateReport = function() {
    // Check if all issues have been reviewed
    let pending = allIssues.filter(function(issue) {
        return issue.status === "pending";
    });
    
    if (pending.length > 0) {
        alert("Please review all issues (Accept or Reject) before generating the report.");
        return;
    }
    
    // Call the original generateReport from web.js
    originalGenerateReport();
    
    // Show the report section
    document.getElementById("reportSection").style.display = "block";
    
    // Scroll to report
    document.getElementById("reportSection").scrollIntoView({ behavior: "smooth" });
};
</script>

</body>
</html>